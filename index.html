<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Bandejas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- Contenedor Principal -->
    <div id="main-container" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-gray-800">Control de Bandejas</h1>
        
        <!-- Indicador de Autenticación y ID de Usuario -->
        <div class="mb-4 p-3 bg-gray-100 rounded-lg shadow-sm">
            <p class="text-sm text-gray-600">
                Estado de la sesión: <span id="auth-status" class="font-semibold text-gray-800">Conectando...</span>
            </p>
            <p class="text-sm text-gray-600 mt-1">
                Tu ID de usuario: <span id="user-id" class="font-mono text-xs break-all text-gray-800">Cargando...</span>
            </p>
        </div>

        <!-- Mensaje de error o de carga -->
        <div id="error-message" class="hidden mb-4 p-3 bg-red-100 rounded-lg text-red-700 text-sm">
            <p>Error: No se pudo conectar a la base de datos. Asegúrate de que este archivo esté siendo servido por un servidor web y no abierto directamente desde tu dispositivo.</p>
        </div>

        <!-- Secciones de la Aplicación -->
        <div id="content-sections">
            <!-- Sección de Resumen de Bandejas -->
            <div id="summary-section" class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Resumen de Bandejas por Tienda</h2>
                <div id="summary-list" class="space-y-4">
                    <p class="text-gray-500">Cargando resumen...</p>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="flex flex-col sm:flex-row gap-4 mb-8">
                <button id="show-outbound-form" class="flex-1 py-3 px-6 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 font-semibold">
                    Registrar Salida
                </button>
                <button id="show-return-form" class="flex-1 py-3 px-6 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 font-semibold">
                    Registrar Retorno
                </button>
            </div>

            <!-- Sección de Historial de Movimientos -->
            <div id="history-section" class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Historial de Movimientos</h2>
                <div id="history-list" class="space-y-4">
                    <p class="text-gray-500">Cargando historial...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales de Formulario -->
    <div id="form-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center hidden p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <h2 id="form-title" class="text-2xl font-bold mb-4"></h2>
            <form id="movement-form" class="space-y-4">
                <div>
                    <label for="registrar-name" class="block text-gray-700 font-medium">Nombre de la Persona que Registra</label>
                    <input type="text" id="registrar-name" name="registrarName" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej. Juan Pérez">
                </div>
                <div>
                    <label for="store-name" class="block text-gray-700 font-medium">Nombre de la Tienda</label>
                    <!-- Menú desplegable para las tiendas -->
                    <select id="store-name" name="storeName" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecciona una tienda</option>
                    </select>
                </div>
                <div>
                    <label for="tray-color" class="block text-gray-700 font-medium">Color de la Bandeja</label>
                    <!-- Menú desplegable para el color de las bandejas -->
                    <select id="tray-color" name="trayColor" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="Plomo">Plomo</option>
                        <option value="Blanco">Blanco</option>
                    </select>
                </div>
                <div>
                    <label for="tray-count" class="block text-gray-700 font-medium">Número de Bandejas</label>
                    <input type="number" id="tray-count" name="trayCount" required min="1" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-form" class="py-2 px-5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200">
                        Cancelar
                    </button>
                    <button type="submit" id="submit-form" class="py-2 px-5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mensaje de Carga y Error -->
    <div id="message-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center hidden p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <p id="message-text" class="text-lg font-medium"></p>
            <button id="close-message" class="mt-4 py-2 px-5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                Aceptar
            </button>
        </div>
    </div>

    <!-- Scripts de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales para la configuración de Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicialización de Firebase
        let app, db, auth;
        let userId = null;
        const errorMessageDiv = document.getElementById('error-message');

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Iniciar sesión con el token de autenticación personalizado o de forma anónima
            // Esto es crucial para que la aplicación funcione en el entorno Canvas.
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken)
                    .catch((error) => {
                        console.error("Error al iniciar sesión con token personalizado:", error);
                        signInAnonymously(auth);
                    });
            } else {
                signInAnonymously(auth)
                    .catch((error) => {
                        console.error("Error al iniciar sesión anónimamente:", error);
                    });
            }
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            document.getElementById('auth-status').textContent = 'Error de conexión';
            errorMessageDiv.classList.remove('hidden');
        }

        // Referencias a elementos del DOM
        const formModal = document.getElementById('form-modal');
        const formTitle = document.getElementById('form-title');
        const movementForm = document.getElementById('movement-form');
        const showOutboundBtn = document.getElementById('show-outbound-form');
        const showReturnBtn = document.getElementById('show-return-form');
        const cancelFormBtn = document.getElementById('cancel-form');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const closeMessageBtn = document.getElementById('close-message');
        const summaryList = document.getElementById('summary-list');
        const historyList = document.getElementById('history-list');

        let movementType = '';
        
        // --- Lista de tiendas (actualizada con tu información) ---
        const storeList = [
            "ALFONSO UGARTE", "ARAMBURU", "AVIACION", "BARRANCO", "BELLAVISTA", 
            "BEN 20", "BEN 49", "BOLIVAR", "BOULEVARD MAGDALENA", "CAMACHO", 
            "CANADA", "CHIMU", "CHORRILLOS", "CIVICO", "COLLIQUE", "COMAS", 
            "ESPINAR", "FAUCETT", "FC PLAZA NORTE", "FOODTRUCK U DE LIMA", "ICA", 
            "JESUS MARIA", "JOCKEY", "LAS FLORES", "LURIN", "MAGDALENA", 
            "MALL AVENTURA SJL", "MALL SUR", "MARINA", "MEGA CHORRILLOS", "MILITAR", 
            "MINKA", "MIOTTA", "MOLINA", "OLIVOS", "PALMERAS", "PLAZA NORTE", 
            "PLAZA VEA MIRAFLORES", "PLAZA VEA VENTANILLA", "POLO", "PRO", "PROCERES", 
            "PURUCHUCO", "RAMBLA", "REPSOL", "REX", "ROYAL PLAZA", "SAENZ PEÑA", 
            "SALAMANCA", "SALAVERRY", "SAN BORJA", "SAN MIGUEL", "STA ANITA", 
            "STA CLARA", "TOMAS VALLE", "UCAYALI", "VALLE HERMOSO", "VILLA EL SALVADOR", 
            "VMT", "GEORGE"
        ];

        // Rellenar el menú desplegable con las tiendas
        const storeSelect = document.getElementById('store-name');
        storeList.forEach(store => {
            const option = document.createElement('option');
            option.value = store;
            option.textContent = store;
            storeSelect.appendChild(option);
        });

        // Escuchar el estado de autenticación del usuario
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('auth-status').textContent = 'Conectado';
                document.getElementById('user-id').textContent = userId;
                console.log(`Usuario autenticado con ID: ${userId}`);
                errorMessageDiv.classList.add('hidden');
                
                // Una vez autenticado, iniciar los listeners de Firestore
                setupFirestoreListeners();
            } else {
                document.getElementById('auth-status').textContent = 'Desconectado';
                document.getElementById('user-id').textContent = 'N/A';
            }
        });

        // Configurar los listeners de Firestore para actualizaciones en tiempo real
        function setupFirestoreListeners() {
            if (!userId) {
                console.error("No se pudo obtener el userId. No se conectará a Firestore.");
                return;
            }
            // Cambiamos la ruta de la colección a una pública para que todos los usuarios compartan los datos
            const movementsCollectionRef = collection(db, `/artifacts/${appId}/public/data/movements`);
            
            // Escucha para el resumen de bandejas
            onSnapshot(movementsCollectionRef, async (snapshot) => {
                const movements = [];
                snapshot.forEach(doc => {
                    movements.push(doc.data());
                });
                updateSummary(movements);
                updateHistory(movements);
            }, (error) => {
                console.error("Error en la escucha de movimientos:", error);
                showMessageModal("Error: No se pudo cargar el resumen de bandejas.");
            });
        }

        // Función para calcular y actualizar el resumen de bandejas
        function updateSummary(movements) {
            const summary = {};
            
            // Calcular el total de bandejas por tienda y color
            movements.forEach(movement => {
                const store = movement.store.toLowerCase();
                const color = movement.color.toLowerCase();
                const key = `${store}-${color}`;

                if (!summary[key]) {
                    summary[key] = { trays: 0, storeName: movement.store, color: movement.color };
                }
                if (movement.type === 'salida') {
                    summary[key].trays += movement.trays;
                } else if (movement.type === 'retorno') {
                    summary[key].trays -= movement.trays;
                }
            });

            // Generar el HTML para el resumen
            const summaryHtml = Object.values(summary).map(item => {
                if (item.trays === 0) return ''; // Ocultar tiendas con 0 bandejas
                const trayText = item.trays === 1 ? 'bandeja' : 'bandejas';
                return `
                    <div class="bg-gray-50 p-4 rounded-lg flex justify-between items-center shadow-sm">
                        <span class="font-medium text-lg">${item.storeName} (${item.color})</span>
                        <span class="text-xl font-bold ${item.trays > 0 ? 'text-blue-600' : 'text-red-600'}">
                            ${item.trays} ${trayText}
                        </span>
                    </div>
                `;
            }).join('');

            summaryList.innerHTML = summaryHtml || '<p class="text-gray-500">No hay bandejas registradas en tiendas.</p>';
        }

        // Función para actualizar el historial de movimientos
        function updateHistory(movements) {
            // Ordenar por fecha de forma descendente
            const sortedMovements = movements.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
            
            const historyHtml = sortedMovements.map(movement => {
                const date = new Date(movement.timestamp.seconds * 1000).toLocaleString();
                const typeClass = movement.type === 'salida' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600';
                const typeText = movement.type === 'salida' ? 'Salida' : 'Retorno';
                const traysText = movement.trays === 1 ? 'bandeja' : 'bandejas';

                return `
                    <div class="p-4 rounded-lg shadow-sm ${typeClass}">
                        <p class="font-semibold text-lg">${typeText} de ${movement.trays} ${traysText} (${movement.color})</p>
                        <p class="text-sm text-gray-700">Tienda: ${movement.store}</p>
                        <p class="text-sm text-gray-700">Registrado por: ${movement.registrar}</p>
                        <p class="text-xs text-gray-500 mt-1">${date}</p>
                    </div>
                `;
            }).join('');

            historyList.innerHTML = historyHtml || '<p class="text-gray-500">No se han registrado movimientos.</p>';
        }

        // Abrir el modal de formulario
        showOutboundBtn.addEventListener('click', () => {
            movementType = 'salida';
            formTitle.textContent = 'Registrar Salida de Bandejas';
            document.getElementById('submit-form').classList.remove('bg-green-600', 'hover:bg-green-700');
            document.getElementById('submit-form').classList.add('bg-blue-600', 'hover:bg-blue-700');
            formModal.classList.remove('hidden');
        });

        showReturnBtn.addEventListener('click', () => {
            movementType = 'retorno';
            formTitle.textContent = 'Registrar Retorno de Bandejas';
            document.getElementById('submit-form').classList.remove('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('submit-form').classList.add('bg-green-600', 'hover:bg-green-700');
            formModal.classList.remove('hidden');
        });

        // Cerrar el modal de formulario
        cancelFormBtn.addEventListener('click', () => {
            formModal.classList.add('hidden');
            movementForm.reset();
        });

        // Manejar el envío del formulario
        movementForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const registrarName = document.getElementById('registrar-name').value.trim();
            const storeName = document.getElementById('store-name').value.trim();
            const trayColor = document.getElementById('tray-color').value.trim();
            const trayCount = parseInt(document.getElementById('tray-count').value, 10);

            if (!storeName || isNaN(trayCount) || trayCount <= 0 || !trayColor || !registrarName) {
                showMessageModal("Por favor, ingresa tu nombre, una tienda, un color y un número de bandejas válido.");
                return;
            }
            
            formModal.classList.add('hidden');
            showMessageModal("Registrando movimiento...", true);

            try {
                const movementsCollectionRef = collection(db, `/artifacts/${appId}/public/data/movements`);
                await addDoc(movementsCollectionRef, {
                    registrar: registrarName,
                    store: storeName,
                    color: trayColor,
                    trays: trayCount,
                    type: movementType,
                    timestamp: new Date()
                });
                showMessageModal("¡Movimiento registrado con éxito!");
                movementForm.reset();
            } catch (error) {
                console.error("Error al añadir el documento:", error);
                showMessageModal(`Error al registrar el movimiento: ${error.message}`);
            }
        });

        // Función para mostrar mensajes en un modal
        function showMessageModal(message, isLoading = false) {
            messageText.textContent = message;
            closeMessageBtn.style.display = isLoading ? 'none' : 'block';
            messageModal.classList.remove('hidden');
        }

        // Cerrar el modal de mensaje
        closeMessageBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

    </script>
</body>
</html>
